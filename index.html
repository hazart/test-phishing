<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://www.gstatic.com https://accounts.google.com https://*.googleapis.com blob: data:;" />
    <title>Redirection</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
      // Configuration Google Sheets API
      const SPREADSHEET_ID = '1-EGzGBogbZv004dt5W9UNIhuQ4H9O-uZObLBlu6vnOc'
      const API_KEY = 'AIzaSyDqEH3AjVtaQN1gfSuea6eHIINKKfhftIU'
      const CLIENT_ID = 'qjkn4uo3u1g6gdapmeltpql3l7a0ct8h.apps.googleusercontent.com'

      // Fonction de log
      function log(message) {
        console.log(`[${new Date().toISOString()}] ${message}`)
        const logElement = document.getElementById('logs')
        if (logElement) {
          logElement.innerHTML += `<div>${message}</div>`
        }
      }

      // Récupérer le paramètre 'user' de l'URL
      const urlParams = new URLSearchParams(window.location.search)
      const user = urlParams.get('user') || ''
      log(`Utilisateur détecté: ${user}`)

      // Construire l'URL de redirection avec le paramètre user
      const baseUrl = 'https://docs.google.com/spreadsheets/d/1kFcIaUQm5o3TGuiK1cPJP7O7Y7yhcFIEcPQuG_ezKnY/edit'
      const redirectUrl = `${baseUrl}?gid=0#gid=0&user=${user}`
      log(`URL de redirection: ${redirectUrl}`)

      // Fonction de redirection
      function redirect() {
        log('Redirection en cours...')
        window.location.href = redirectUrl
      }

      // Fonction pour initialiser l'API Google Sheets
      function initGoogleSheetsAPI() {
        log("Initialisation de l'API Google Sheets...")
        gapi.client
          .init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest'],
            scope: 'https://www.googleapis.com/auth/spreadsheets',
          })
          .then(() => {
            // Ajout de l'authentification explicite
            return gapi.auth2.getAuthInstance().signIn()
          })
          .then(() => {
            log('Authentification réussie')
            // Enregistrer la connexion
            const timestamp = new Date().toISOString()
            const values = [[timestamp, user]]
            log(`Données à enregistrer: Timestamp=${timestamp}, User=${user}`)

            gapi.client.sheets.spreadsheets.values
              .append({
                spreadsheetId: '1kFcIaUQm5o3TGuiK1cPJP7O7Y7yhcFIEcPQuG_ezKnY',
                range: 'Logs!A:B',
                valueInputOption: 'RAW',
                resource: {
                  values: values,
                },
              })
              .then((response) => {
                log('Connexion enregistrée avec succès')
                log(`Réponse API: ${JSON.stringify(response)}`)
                redirect()
              })
              .catch((error) => {
                log(`Erreur lors de l'enregistrement: ${error.message}`)
                console.error('Erreur détaillée:', error)
                document.getElementById('error-message').style.display = 'block'
                setTimeout(redirect, 50000)
              })
          })
          .catch((error) => {
            log(`Erreur d'initialisation de l'API: ${error}`)
            console.error("Erreur détaillée d'initialisation:", error)
            document.getElementById('error-message').style.display = 'block'
          })
      }

      // Charger l'API Google Sheets
      log("Chargement de l'API Google Sheets...")
      gapi.load('client:auth2', initGoogleSheetsAPI)
    </script>
  </head>
  <body>
    <p>Enregistrement de votre connexion...</p>
    <div id="logs" style="font-family: monospace; margin: 20px; padding: 10px; background-color: #f5f5f5"></div>
    <p id="error-message" style="display: none; color: red">Une erreur est survenue lors de l'enregistrement. Redirection dans 50 secondes...</p>
  </body>
</html>
