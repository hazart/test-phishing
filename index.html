<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Redirection</title>
    <script>
      // Fonction de log
      function log(message) {
        console.log(`[${new Date().toISOString()}] ${message}`)
        const logElement = document.getElementById('logs')
        if (logElement) {
          logElement.innerHTML += `<div>${message}</div>`
        }
      }

      // Récupérer le paramètre 'user' de l'URL
      const urlParams = new URLSearchParams(window.location.search)
      const user = urlParams.get('user') || ''
      log(`Utilisateur détecté: ${user}`)

      // Construire l'URL de redirection avec le paramètre user
      const baseUrl = 'https://docs.google.com/spreadsheets/d/1kFcIaUQm5o3TGuiK1cPJP7O7Y7yhcFIEcPQuG_ezKnY/edit'
      const redirectUrl = `${baseUrl}?gid=0#gid=0&user=${user}`
      log(`URL de redirection: ${redirectUrl}`)

      // URL du script Google Apps (à remplacer par l'URL de votre déploiement)
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby6ygTpi7D_ZQVQVN31xu744duXCLaMYP2h2J3bhIMfwyijmLoTge8JLSAGgGt3OIyTrQ/exec'

      // Fonction de redirection
      function redirect() {
        log('Redirection en cours...')
        window.location.href = redirectUrl
      }

      // Fonction pour enregistrer la connexion
      function logConnection() {
        const params = new URLSearchParams({
          user: user,
        })

        fetch(`${SCRIPT_URL}?${params.toString()}`)
          .then((response) => response.json())
          .then((data) => {
            log(`Réponse du script: ${JSON.stringify(data)}`)
            if (data.status === 'success') {
              redirect()
            } else {
              throw new Error(data.message)
            }
          })
          .catch((error) => {
            log(`Erreur: ${error.message}`)
            console.error('Erreur détaillée:', error)
            document.getElementById('error-message').style.display = 'block'
            setTimeout(redirect, 3000)
          })
      }

      // Lancer l'enregistrement
      logConnection()
    </script>
  </head>
  <body>
    <p>Enregistrement de votre connexion...</p>
    <div id="logs" style="font-family: monospace; margin: 20px; padding: 10px; background-color: #f5f5f5"></div>
    <p id="error-message" style="display: none; color: red">Une erreur est survenue lors de l'enregistrement. Redirection dans 3 secondes...</p>
  </body>
</html>
